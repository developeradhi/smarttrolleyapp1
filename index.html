<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SuperPOS Pro | Retail Management System</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

    <style>
        /* Enterprise Styling */
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #e2e8f0; height: 100vh; overflow: hidden; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        
        /* POS Layout */
        .pos-grid { display: grid; grid-template-columns: 280px 1fr 400px; height: 100vh; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }

        /* Mobile Responsive Fallback */
        @media (max-width: 1024px) {
            .pos-grid { grid-template-columns: 1fr; grid-template-rows: auto 1fr auto; }
            .sidebar { display: none; }
            .bill-panel { position: fixed; bottom: 0; left: 0; width: 100%; height: 60vh; transform: translateY(100%); transition: 0.3s; z-index: 40; }
            .bill-panel.open { transform: translateY(0); }
        }

        /* --- THERMAL RECEIPT PRINTING STYLES (CRITICAL FIX) --- */
        @media print {
            body * {
                visibility: hidden;
            }
            #receipt-print-area, #receipt-print-area * {
                visibility: visible;
            }
            #receipt-print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                margin: 0;
                padding: 10px;
                background: white;
                color: black;
                font-family: 'Courier New', Courier, monospace; /* Thermal printer font look */
            }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body>

<div class="pos-grid">
    
    <aside class="sidebar bg-slate-900 border-r border-slate-800 flex flex-col no-print">
        <div class="p-6 border-b border-slate-800 flex items-center gap-3">
            <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center font-bold text-xl text-white">S</div>
            <div>
                <h1 class="font-bold text-lg leading-none text-white">SuperPOS</h1>
                <span class="text-xs text-slate-500">v2.4 Enterprise</span>
            </div>
        </div>

        <nav class="flex-1 p-4 space-y-2">
            <button onclick="setView('pos')" id="nav-pos" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg bg-blue-600 text-white font-medium transition">
                <i class="fa-solid fa-cash-register"></i> Billing Terminal
            </button>
            <button onclick="setView('inventory')" id="nav-inventory" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-slate-800 text-slate-400 font-medium transition">
                <i class="fa-solid fa-boxes-stacked"></i> Inventory Manager
            </button>
        </nav>

        <div class="p-4 bg-slate-800 mt-auto">
            <div class="flex items-center justify-between mb-2">
                <span class="text-xs text-slate-400 uppercase">Status</span>
                <span class="text-xs font-bold text-green-400">● Online</span>
            </div>
            <div class="text-sm font-bold text-white">Operator: Admin</div>
            <div class="text-xs text-slate-500" id="clock">00:00:00</div>
        </div>
    </aside>

    <main class="bg-slate-950 flex flex-col relative">
        
        <header class="h-16 border-b border-slate-800 flex items-center justify-between px-6 bg-slate-900 no-print">
            <div class="flex items-center gap-4">
                <h2 class="font-bold text-slate-200" id="page-title">Billing Terminal</h2>
                <span id="scanner-status" class="text-xs px-2 py-1 rounded bg-red-900/50 text-red-400 border border-red-800">Scanner Offline</span>
            </div>
            <div class="flex gap-3">
                <button onclick="toggleScanner()" class="px-4 py-2 bg-slate-800 hover:bg-slate-700 rounded-lg text-sm border border-slate-700 transition text-white">
                    <i class="fa-solid fa-camera"></i> Toggle Camera
                </button>
                <button onclick="resetCart()" class="px-4 py-2 bg-red-900/30 text-red-400 hover:bg-red-900/50 rounded-lg text-sm border border-red-900/50 transition">
                    <i class="fa-solid fa-ban"></i> Clear
                </button>
            </div>
        </header>

        <div id="view-pos" class="flex-1 p-6 overflow-y-auto">
            <div id="scanner-container" class="hidden mb-6 bg-black rounded-xl overflow-hidden border-2 border-slate-700 shadow-2xl relative h-64">
                <div id="reader" class="w-full h-full"></div>
                <div class="absolute inset-0 border-2 border-red-500/50 pointer-events-none m-12 rounded opacity-50"></div>
                <div class="absolute bottom-2 left-0 w-full text-center text-xs text-white/70">Align Barcode</div>
            </div>

            <div class="bg-slate-900 p-6 rounded-xl border border-slate-800 shadow-lg">
                <label class="text-xs font-bold text-slate-400 uppercase mb-2 block">Product Lookup</label>
                <div class="flex gap-3">
                    <div class="relative flex-1">
                        <i class="fa-solid fa-barcode absolute left-4 top-4 text-slate-500"></i>
                        <input type="text" id="barcode-input" placeholder="Scan or type barcode..." 
                            class="w-full bg-slate-950 border border-slate-700 rounded-lg py-3 pl-12 pr-4 text-white font-mono focus:border-blue-500 focus:outline-none transition"
                            autofocus onkeypress="handleEnter(event)">
                    </div>
                    <button onclick="manualScan()" class="bg-blue-600 hover:bg-blue-500 text-white px-8 rounded-lg font-bold transition">ADD</button>
                </div>
                
                <div class="mt-6">
                    <p class="text-xs text-slate-500 mb-3">QUICK ACCESS</p>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3" id="quick-keys">
                        </div>
                </div>
            </div>
        </div>

        <div id="view-inventory" class="hidden flex-1 p-6 overflow-y-auto">
            <div class="bg-slate-900 rounded-xl border border-slate-800 overflow-hidden">
                <div class="p-4 border-b border-slate-800 flex justify-between">
                    <h3 class="font-bold text-white">Stock Database</h3>
                    <button onclick="openAddModal()" class="text-blue-400 text-sm hover:underline">+ Add New Item</button>
                </div>
                <table class="w-full text-left text-sm text-slate-300">
                    <thead class="bg-slate-950 text-slate-400">
                        <tr><th class="p-4">Barcode</th><th class="p-4">Name</th><th class="p-4 text-right">Price</th><th class="p-4 text-center">Action</th></tr>
                    </thead>
                    <tbody id="inventory-list" class="divide-y divide-slate-800"></tbody>
                </table>
            </div>
        </div>
    </main>

    <aside class="bill-panel bg-slate-900 border-l border-slate-800 flex flex-col w-full h-full no-print">
        <div class="p-4 border-b border-slate-800 bg-slate-900">
            <h3 class="font-bold text-slate-300">Current Bill</h3>
            <p class="text-xs text-slate-500">Invoice #<span id="invoice-num">...</span></p>
        </div>

        <div class="flex-1 overflow-y-auto p-2 space-y-1" id="cart-list">
            <div class="h-full flex flex-col items-center justify-center text-slate-600 opacity-50">
                <i class="fa-solid fa-basket-shopping text-4xl mb-2"></i>
                <p>Cart Empty</p>
            </div>
        </div>

        <div class="p-6 bg-slate-950 border-t border-slate-800 shadow-[0_-10px_40px_rgba(0,0,0,0.3)]">
            <div class="space-y-2 mb-4 text-sm">
                <div class="flex justify-between text-slate-400"><span>Subtotal</span><span id="lbl-sub">0.00</span></div>
                <div class="flex justify-between text-slate-400"><span>Tax (18%)</span><span id="lbl-tax">0.00</span></div>
            </div>
            <div class="flex justify-between items-end mb-6">
                <span class="text-xl font-bold text-white">TOTAL</span>
                <span class="text-4xl font-mono font-bold text-green-400">₹<span id="lbl-total">0.00</span></span>
            </div>
            
            <button onclick="openPaymentModal()" class="w-full bg-green-600 hover:bg-green-500 text-white py-4 rounded-xl font-bold text-lg shadow-lg shadow-green-900/20 transition transform active:scale-95">
                PAY & PRINT
            </button>
        </div>
    </aside>
</div>

<div id="payment-modal" class="fixed inset-0 bg-black/80 z-50 hidden flex items-center justify-center backdrop-blur-sm p-4 no-print">
    <div class="bg-slate-900 w-full max-w-md rounded-2xl border border-slate-700 shadow-2xl p-6">
        <h3 class="text-xl font-bold text-white mb-6">Payment Method</h3>
        
        <div class="grid grid-cols-3 gap-4 mb-6">
            <button onclick="completePayment('CASH')" class="bg-slate-800 hover:bg-slate-700 p-4 rounded-xl border border-slate-700 flex flex-col items-center gap-2 transition text-white">
                <i class="fa-solid fa-money-bill-wave text-2xl text-green-400"></i>
                <span class="text-xs font-bold">CASH</span>
            </button>
            <button onclick="completePayment('UPI')" class="bg-slate-800 hover:bg-slate-700 p-4 rounded-xl border border-slate-700 flex flex-col items-center gap-2 transition text-white">
                <i class="fa-solid fa-qrcode text-2xl text-blue-400"></i>
                <span class="text-xs font-bold">UPI</span>
            </button>
            <button onclick="completePayment('CARD')" class="bg-slate-800 hover:bg-slate-700 p-4 rounded-xl border border-slate-700 flex flex-col items-center gap-2 transition text-white">
                <i class="fa-solid fa-credit-card text-2xl text-yellow-400"></i>
                <span class="text-xs font-bold">CARD</span>
            </button>
        </div>
        <button onclick="document.getElementById('payment-modal').classList.add('hidden')" class="w-full py-3 text-slate-400 hover:text-white">Cancel</button>
    </div>
</div>

<div id="add-modal" class="fixed inset-0 bg-black/80 z-50 hidden flex items-center justify-center p-4 no-print">
    <div class="bg-slate-900 w-full max-w-sm rounded-xl border border-slate-700 p-6">
        <h3 class="font-bold text-white mb-4">Add Inventory</h3>
        <input id="new-code" placeholder="Barcode" class="w-full bg-slate-950 border border-slate-700 rounded p-3 mb-3 text-white">
        <input id="new-name" placeholder="Product Name" class="w-full bg-slate-950 border border-slate-700 rounded p-3 mb-3 text-white">
        <input id="new-price" type="number" placeholder="Price" class="w-full bg-slate-950 border border-slate-700 rounded p-3 mb-4 text-white">
        <button onclick="saveProduct()" class="w-full bg-blue-600 text-white py-3 rounded font-bold">Save Item</button>
        <button onclick="document.getElementById('add-modal').classList.add('hidden')" class="w-full py-3 text-slate-500">Cancel</button>
    </div>
</div>

<div id="receipt-print-area" class="hidden">
    <div style="text-align: center; width: 300px; margin: 0 auto;">
        <h2 style="margin:0; font-size: 1.5em; font-weight: bold;">SUPER POS STORE</h2>
        <p style="margin: 5px 0 15px 0; font-size: 0.8em;">Bangalore, KA - 560068<br>GSTIN: 29ABCDE1234F1Z5</p>
        
        <div style="border-bottom: 1px dashed black; margin-bottom: 10px;"></div>
        
        <div style="display: flex; justify-content: space-between; font-weight: bold; font-size: 0.9em; margin-bottom: 5px;">
            <span>ITEM</span>
            <span>AMT</span>
        </div>

        <div id="print-items-list" style="font-size: 0.9em; text-align: left; margin-bottom: 10px;">
            </div>

        <div style="border-bottom: 1px dashed black; margin-bottom: 10px;"></div>

        <div style="display: flex; justify-content: space-between; font-weight: bold; font-size: 1.2em;">
            <span>TOTAL</span>
            <span id="print-total-amount">0.00</span>
        </div>
        
        <p style="margin-top: 20px; font-size: 0.8em;">
            Mode: <span id="print-payment-mode">CASH</span><br>
            Date: <span id="print-date"></span>
        </p>
        <p style="margin-top: 10px; font-weight: bold;">*** THANK YOU ***</p>
    </div>
</div>

<script>
    // --- 1. DATA CORE ---
    let db = JSON.parse(localStorage.getItem('superpos_db')) || {
        '101': { name: 'Fresh Milk 500ml', price: 28 },
        '102': { name: 'Whole Wheat Bread', price: 45 },
        '103': { name: 'Farm Eggs (6pcs)', price: 55 },
        '104': { name: 'Maggi Noodles', price: 14 },
        '105': { name: 'Coca Cola 750ml', price: 40 },
        '106': { name: 'Lays Chips', price: 20 }
    };
    
    let cart = [];
    let scanner = null;
    let currentInv = Math.floor(Math.random() * 900000) + 100000;

    // --- 2. INITIALIZATION ---
    window.onload = () => {
        document.getElementById('invoice-num').innerText = currentInv;
        renderQuickKeys();
        renderInventory();
        document.getElementById('barcode-input').focus();
        
        setInterval(() => {
            document.getElementById('clock').innerText = new Date().toLocaleTimeString();
        }, 1000);
    };

    // --- 3. SCANNER LOGIC ---
    function toggleScanner() {
        const container = document.getElementById('scanner-container');
        const status = document.getElementById('scanner-status');
        
        if (container.classList.contains('hidden')) {
            container.classList.remove('hidden');
            status.innerText = "Initializing...";
            
            scanner = new Html5Qrcode("reader");
            scanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, 
                onScanSuccess, 
                (err) => { console.log("Scanning..."); }
            ).then(() => {
                status.innerText = "● Online";
                status.className = "text-xs px-2 py-1 rounded bg-green-900/50 text-green-400 border border-green-800";
            }).catch(err => {
                alert("Camera Error: Ensure you are on HTTPS or Localhost.");
                container.classList.add('hidden');
            });
        } else {
            if (scanner) scanner.stop().then(() => scanner.clear());
            container.classList.add('hidden');
            status.innerText = "Offline";
            status.className = "text-xs px-2 py-1 rounded bg-red-900/50 text-red-400 border border-red-800";
        }
    }

    function onScanSuccess(code) {
        new Audio('https://www.soundjay.com/buttons/beep-01a.mp3').play().catch(e=>{});
        processBarcode(code);
        if(scanner) scanner.pause();
        setTimeout(() => scanner && scanner.resume(), 1000);
    }

    // --- 4. BILLING & CART ---
    function manualScan() {
        const input = document.getElementById('barcode-input');
        const code = input.value.trim();
        if(code) processBarcode(code);
        input.value = "";
        input.focus();
    }

    function handleEnter(e) {
        if(e.key === 'Enter') manualScan();
    }

    function processBarcode(code) {
        if (db[code]) {
            addToCart(code);
        } else {
            if(confirm(`Item ${code} not found. Add to database?`)) {
                openAddModal(code);
            }
        }
    }

    function addToCart(code) {
        const item = db[code];
        const existing = cart.find(x => x.code === code);
        if (existing) existing.qty++;
        else cart.push({ code, ...item, qty: 1 });
        renderCart();
    }

    function renderCart() {
        const list = document.getElementById('cart-list');
        if (cart.length === 0) {
            list.innerHTML = `<div class="h-full flex flex-col items-center justify-center text-slate-600 opacity-50"><i class="fa-solid fa-basket-shopping text-4xl mb-2"></i><p>Cart Empty</p></div>`;
            updateTotals(0);
            return;
        }

        list.innerHTML = cart.map((item, i) => `
            <div class="bg-slate-800 p-3 rounded flex justify-between items-center group mb-2 border border-slate-700">
                <div>
                    <div class="text-white font-bold text-sm">${item.name}</div>
                    <div class="text-xs text-slate-400">₹${item.price} x ${item.qty}</div>
                </div>
                <div class="flex items-center gap-3">
                    <span class="font-mono font-bold text-white">₹${item.price * item.qty}</span>
                    <button onclick="remItem(${i})" class="text-red-500 transition hover:text-red-400"><i class="fa-solid fa-trash"></i></button>
                </div>
            </div>
        `).join('');
        
        const total = cart.reduce((sum, x) => sum + (x.price * x.qty), 0);
        updateTotals(total);
    }

    function updateTotals(subtotal) {
        const tax = subtotal * 0.18;
        const total = subtotal + tax;
        document.getElementById('lbl-sub').innerText = subtotal.toFixed(2);
        document.getElementById('lbl-tax').innerText = tax.toFixed(2);
        document.getElementById('lbl-total').innerText = total.toFixed(2);
    }

    function remItem(i) {
        cart.splice(i, 1);
        renderCart();
    }

    function resetCart() {
        cart = [];
        renderCart();
    }

    // --- 5. PAYMENT & PRINTING (FIXED) ---
    function openPaymentModal() {
        if (cart.length === 0) return alert("Cart is empty!");
        document.getElementById('payment-modal').classList.remove('hidden');
    }

    function completePayment(mode) {
        // 1. Fill Receipt Data
        const list = document.getElementById('print-items-list');
        list.innerHTML = cart.map(x => `
            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                <span>${x.name} <small>(x${x.qty})</small></span>
                <span>${(x.price * x.qty).toFixed(2)}</span>
            </div>
        `).join('');

        document.getElementById('print-total-amount').innerText = document.getElementById('lbl-total').innerText;
        document.getElementById('print-payment-mode').innerText = mode;
        document.getElementById('print-date').innerText = new Date().toLocaleString();

        // 2. Hide Modal & Print
        document.getElementById('payment-modal').classList.add('hidden');
        
        // Timeout ensures the DOM updates before print dialog opens
        setTimeout(() => {
            window.print();
            // Reset after print dialog closes
            resetCart();
            currentInv++;
            document.getElementById('invoice-num').innerText = currentInv;
        }, 500);
    }

    // --- 6. INVENTORY ---
    function openAddModal(prefillCode = "") {
        document.getElementById('add-modal').classList.remove('hidden');
        document.getElementById('new-code').value = prefillCode;
        document.getElementById('new-name').focus();
    }

    function saveProduct() {
        const code = document.getElementById('new-code').value;
        const name = document.getElementById('new-name').value;
        const price = Number(document.getElementById('new-price').value);

        if (code && name && price) {
            db[code] = { name, price };
            localStorage.setItem('superpos_db', JSON.stringify(db));
            renderInventory();
            renderQuickKeys();
            document.getElementById('add-modal').classList.add('hidden');
            if (cart.length > 0 || confirm("Add new item to current bill?")) {
                addToCart(code);
            }
        }
    }

    function renderInventory() {
        const tbody = document.getElementById('inventory-list');
        tbody.innerHTML = Object.entries(db).map(([code, item]) => `
            <tr class="hover:bg-slate-800 border-b border-slate-800 text-slate-300">
                <td class="p-4 font-mono">${code}</td>
                <td class="p-4 font-bold text-white">${item.name}</td>
                <td class="p-4 text-right">₹${item.price}</td>
                <td class="p-4 text-center"><button onclick="deleteProduct('${code}')" class="text-red-500 hover:text-red-400"><i class="fa-solid fa-trash"></i></button></td>
            </tr>
        `).join('');
    }

    function renderQuickKeys() {
        const div = document.getElementById('quick-keys');
        div.innerHTML = Object.entries(db).slice(0, 8).map(([code, item]) => `
            <button onclick="processBarcode('${code}')" class="bg-slate-800 hover:bg-blue-600 border border-slate-700 rounded p-2 text-left transition group">
                <div class="text-xs text-slate-500 group-hover:text-blue-200">${code}</div>
                <div class="font-bold text-white text-sm truncate">${item.name}</div>
            </button>
        `).join('');
    }

    function deleteProduct(code) {
        if(confirm("Delete item?")) {
            delete db[code];
            localStorage.setItem('superpos_db', JSON.stringify(db));
            renderInventory();
            renderQuickKeys();
        }
    }

    function setView(viewId) {
        ['pos', 'inventory'].forEach(v => document.getElementById('view-'+v)?.classList.add('hidden'));
        document.getElementById('view-'+viewId)?.classList.remove('hidden');
    }
</script>

</body>
</html>
